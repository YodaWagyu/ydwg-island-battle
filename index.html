<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Island Battle Royale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Kanit', sans-serif;
            background-color: #0f172a;
            background-image:
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .grid-cell {
            width: 2.5rem;
            height: 2.5rem;
            aspect-ratio: 1;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Grid Visuals */
        .grid-cell::before {
            content: '';
            position: absolute;
            inset: 0;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            pointer-events: none;
        }

        .grid-cell:hover {
            transform: scale(0.95);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.5);
            z-index: 10;
            border-radius: 4px;
        }

        /* Terrain Colors */
        .cell-water {
            background-color: #1e293b;
            opacity: 0.8;
        }

        .cell-island {
            background-color: #059669;
            background-image: linear-gradient(45deg, #047857 25%, transparent 25%, transparent 50%, #047857 50%, #047857 75%, transparent 75%, transparent);
            background-size: 10px 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .cell-ship {
            background-color: #475569;
            border: 2px solid #94a3b8;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .cell-turret {
            background-color: #d97706;
        }

        .cell-turret::after {
            content: 'üõ°Ô∏è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.5));
        }

        /* Effects */
        .cell-hit {
            background-color: #dc2626 !important;
            animation: shake 0.5s;
        }

        .cell-hit::after {
            content: 'üí•';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cell-miss {
            background-color: #334155 !important;
        }

        .cell-miss::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .cell-island-hit {
            background-color: #166534 !important;
        }

        .cell-island-hit::after {
            content: 'üî•';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-2px) rotate(-2deg);
            }

            75% {
                transform: translateX(2px) rotate(2deg);
            }
        }

        .hidden-el {
            display: none !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body class="text-slate-200 min-h-screen selection:bg-blue-500 selection:text-white">

    <!-- Login Screen -->
    <div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen p-6 relative overflow-hidden">
        <!-- Decoration -->
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-green-500"></div>
        <div class="absolute -top-40 -left-40 w-96 h-96 bg-blue-600/20 rounded-full blur-3xl pointer-events-none"></div>
        <div class="absolute -bottom-40 -right-40 w-96 h-96 bg-green-600/20 rounded-full blur-3xl pointer-events-none">
        </div>

        <div class="z-10 text-center mb-8">
            <div class="inline-block p-4 rounded-full bg-slate-800/50 mb-4 border border-slate-700 shadow-2xl">
                <i class="fa-solid fa-ship text-4xl text-blue-400"></i>
            </div>
            <h1
                class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400 mb-2 tracking-tight">
                ISLAND BATTLE</h1>
            <p class="text-slate-400 font-light tracking-widest text-sm uppercase">Tactical Naval Warfare</p>
        </div>

        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-sm relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-1 h-full bg-blue-500 opacity-50 group-hover:opacity-100 transition">
            </div>

            <div class="mb-6">
                <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Identify
                    Yourself</label>
                <input type="text" id="usernameInput"
                    class="w-full bg-slate-900/80 p-4 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 border border-slate-700 text-lg placeholder-slate-600 transition-all text-center font-mono"
                    placeholder="ENTER CALLSIGN">
            </div>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="joinGame('client')"
                    class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-4 rounded-lg shadow-lg shadow-blue-900/50 transition-all transform hover:translate-y-px hover:shadow-xl flex items-center justify-center gap-2 group-hover:tracking-wide">
                    <span>JOIN OPERATION</span> <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
                <button onclick="showPasswordModal()"
                    class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 rounded-lg border border-slate-700 transition-all flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-user-shield"></i> <span>ADMIRAL LOGIN</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal"
        class="hidden-el fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl shadow-2xl w-full max-w-xs transform transition-all scale-100">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i
                    class="fa-solid fa-key text-yellow-500"></i> Security Clearance</h3>
            <input type="password" id="hostPasswordInput"
                class="w-full bg-slate-900/80 p-3 rounded text-white border border-slate-700 mb-4 focus:outline-none focus:border-blue-500 font-mono tracking-widest"
                placeholder="ENTER PASSCODE">
            <div class="flex gap-2">
                <button onclick="closePasswordModal()"
                    class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded font-bold text-sm">CANCEL</button>
                <button onclick="verifyHost()"
                    class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-sm">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="hidden-el flex flex-col items-center min-h-screen p-4 md:p-8">
        <div class="w-full max-w-4xl">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-white">COMMAND CENTER</h2>
                    <p class="text-slate-400 text-sm">Waiting for deployment...</p>
                </div>
                <div
                    class="glass-panel px-4 py-2 rounded-full text-xs font-mono text-green-400 flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ONLINE
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl border-t-4 border-t-blue-500 shadow-2xl mb-8">
                <div class="flex justify-between items-end border-b border-slate-700 pb-4 mb-6">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-users text-slate-500"></i> Active Units
                    </h3>
                    <span class="text-2xl font-mono font-bold text-blue-400"><span id="playerCount">0</span><span
                            class="text-slate-600 text-lg">/10</span></span>
                </div>

                <div id="lobbyPlayerList"
                    class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Player items will go here -->
                </div>
            </div>

            <div id="hostControls" class="hidden-el flex justify-center">
                <button onclick="startGame()"
                    class="bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-16 rounded-full shadow-lg shadow-green-900/50 text-xl tracking-wider transition-all hover:scale-105 flex items-center gap-3">
                    <i class="fa-solid fa-play"></i> INITIATE BATTLE
                </button>
            </div>
            <div id="clientWaiting" class="text-center">
                <div
                    class="inline-flex items-center gap-3 text-slate-400 bg-slate-800/50 px-6 py-3 rounded-full animate-pulse">
                    <i class="fa-solid fa-satellite-dish"></i> Awaiting Commander's Signal...
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Phase -->
    <div id="setupScreen" class="hidden-el flex flex-col h-screen overflow-hidden bg-slate-900">
        <!-- HUD Header -->
        <header class="glass-panel p-3 flex justify-between items-center z-20 shadow-lg">
            <div class="flex items-center gap-4">
                <div
                    class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-compass-drafting text-white"></i>
                </div>
                <div>
                    <h2 class="font-bold text-sm text-slate-300 uppercase tracking-wider">Setup Phase</h2>
                    <div class="text-xs text-slate-500 font-mono">Territory Configuration</div>
                </div>
            </div>

            <div
                class="flex gap-2 md:gap-6 text-xs md:text-sm font-mono bg-slate-950/50 p-2 rounded-lg border border-slate-800">
                <div id="islandCountStatus" class="flex flex-col items-center px-2">
                    <span class="text-slate-500 text-[10px] uppercase">Terrain</span>
                    <span class="font-bold text-slate-200">0/32</span>
                </div>
                <div class="w-px bg-slate-800"></div>
                <div id="turretCountStatus" class="flex flex-col items-center px-2">
                    <span class="text-slate-500 text-[10px] uppercase">Defense</span>
                    <span class="font-bold text-yellow-500">0/3</span>
                </div>
                <div class="w-px bg-slate-800"></div>
                <div id="shipCountStatus" class="flex flex-col items-center px-2">
                    <span class="text-slate-500 text-[10px] uppercase">Fleet</span>
                    <span class="font-bold text-blue-400">0/5</span>
                </div>
            </div>

            <button onclick="submitBoard()" id="readyBtn"
                class="bg-slate-700 text-slate-400 px-6 py-2 rounded border border-slate-600 cursor-not-allowed font-bold transition-all text-sm uppercase tracking-wide"
                disabled>
                Confirm Layout
            </button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Toolbar -->
            <aside
                class="w-64 glass-panel border-r-0 border-t-0 border-b-0 border-l border-white/5 flex flex-col gap-1 p-0 z-10">
                <div class="p-4 bg-slate-950/50 border-b border-white/5">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Tools</h3>
                </div>

                <div class="p-4 flex flex-col gap-3 overflow-y-auto">
                    <!-- Terrain Tools -->
                    <div class="space-y-2">
                        <label class="text-[10px] text-slate-500 font-bold uppercase">1. Territory</label>
                        <button onclick="setTool('island')" id="tool-island"
                            class="tool-btn w-full bg-slate-800 hover:bg-slate-700 p-3 rounded text-left border border-slate-700 transition flex items-center gap-3 group">
                            <div
                                class="w-8 h-8 rounded bg-green-600/20 text-green-500 flex items-center justify-center group-hover:bg-green-500 group-hover:text-white transition">
                                <i class="fa-solid fa-mountain"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-200">Build Land</div>
                                <div class="text-[10px] text-slate-500">Max 32 Tiles</div>
                            </div>
                        </button>
                        <button onclick="setTool('water')" id="tool-water"
                            class="tool-btn w-full bg-slate-800 hover:bg-slate-700 p-3 rounded text-left border border-slate-700 transition flex items-center gap-3 group">
                            <div
                                class="w-8 h-8 rounded bg-blue-600/20 text-blue-500 flex items-center justify-center group-hover:bg-blue-500 group-hover:text-white transition">
                                <i class="fa-solid fa-water"></i>
                            </div>
                            <div class="text-sm font-bold text-slate-200">Remove</div>
                        </button>
                    </div>

                    <!-- Defense Tools -->
                    <div class="space-y-2 mt-2">
                        <label class="text-[10px] text-slate-500 font-bold uppercase">2. Defense</label>
                        <button onclick="setTool('turret')" id="tool-turret"
                            class="tool-btn w-full bg-slate-800 hover:bg-slate-700 p-3 rounded text-left border border-slate-700 transition flex items-center gap-3 group">
                            <div
                                class="w-8 h-8 rounded bg-yellow-600/20 text-yellow-500 flex items-center justify-center group-hover:bg-yellow-500 group-hover:text-white transition">
                                <i class="fa-solid fa-shield-halved"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-200">Turret</div>
                                <div class="text-[10px] text-slate-500">Max 3 Units</div>
                            </div>
                        </button>
                    </div>

                    <!-- Fleet Tools -->
                    <div class="space-y-2 mt-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[10px] text-slate-500 font-bold uppercase">3. Fleet</label>
                            <button onclick="toggleRotation()"
                                class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-300 hover:text-white border border-slate-700">
                                <i class="fa-solid fa-rotate"></i> <span id="rotateText">Horz</span>
                            </button>
                        </div>
                        <div id="shipButtons" class="flex flex-col gap-2"></div>
                    </div>
                </div>
            </aside>

            <!-- Main Grid Area -->
            <main class="flex-1 bg-slate-950 relative flex justify-center items-center p-4 overflow-auto">
                <!-- Grid Background Effect -->
                <div class="absolute inset-0 opacity-10"
                    style="background-image: radial-gradient(#3b82f6 1px, transparent 1px); background-size: 20px 20px;">
                </div>

                <div id="setupGrid"
                    class="relative z-10 grid grid-cols-12 gap-px bg-slate-800 border-2 border-slate-700 shadow-2xl p-2 rounded-lg backdrop-blur-sm"
                    style="width: fit-content;">
                    <!-- Cells generated by JS -->
                </div>
            </main>
        </div>

        <!-- Setup Waiting Room (Overlay) -->
        <div id="setupWaitingRoom"
            class="hidden-el absolute inset-0 z-50 bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center p-8">
            <div class="w-full max-w-2xl">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">DEPLOYMENT STAGING AREA</h2>
                    <p class="text-slate-400">Waiting for all fleets to report readiness...</p>
                </div>

                <div class="glass-panel p-6 rounded-xl border border-slate-700 shadow-2xl mb-8">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-4 mb-4">
                        <h3 class="font-bold text-slate-300">Fleet Status</h3>
                        <div class="text-xs font-mono text-slate-500">LIVE FEED</div>
                    </div>
                    <div id="setupPlayerList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Player Status Items -->
                    </div>
                </div>

                <div id="setupHostControls" class="hidden-el flex justify-center">
                    <button onclick="initiateBattleSequence()" id="forceStartBtn" disabled
                        class="bg-green-600 hover:bg-green-500 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-bold py-4 px-12 rounded-full shadow-lg transition-all flex items-center gap-3">
                        <i class="fa-solid fa-meteor"></i> INITIATE BATTLE SEQUENCE
                    </button>
                </div>
                <div id="setupClientMessage" class="text-center text-slate-500 animate-pulse mt-4">
                    <i class="fa-solid fa-hourglass-half"></i> Awaiting Commander's Order...
                </div>
            </div>
        </div>
    </div>

    <!-- Battle Phase -->
    <div id="battleScreen" class="hidden-el flex flex-col h-screen overflow-hidden bg-slate-900">
        <!-- Battle HUD -->
        <header class="glass-panel p-3 flex justify-between items-center z-20 shadow-lg border-b border-red-900/30">
            <div class="flex items-center gap-6">
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Operation Round</span>
                    <span class="text-2xl font-bold text-white font-mono leading-none">#<span
                            id="roundDisplay">1</span></span>
                </div>

                <div class="h-8 w-px bg-slate-700"></div>

                <div class="flex items-center gap-3">
                    <div class="bg-slate-800 p-2 rounded-lg border border-slate-700 flex items-center gap-3">
                        <div class="bg-green-900/30 text-green-500 p-1 rounded"><i
                                class="fa-solid fa-boxes-stacked"></i></div>
                        <div class="flex flex-col">
                            <span class="text-[10px] text-slate-500 uppercase">Ammo</span>
                            <span class="font-bold text-green-400 font-mono leading-none text-lg" id="myAmmo">3</span>
                        </div>
                    </div>
                    <div class="text-xs text-slate-500 font-mono">
                        BONUS: +<span id="bonusAmmo" class="text-green-400">0</span>
                    </div>
                </div>
            </div>

            <div id="phaseStatus"
                class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden md:flex items-center gap-2 text-blue-300 font-mono text-sm bg-blue-900/20 px-4 py-1 rounded-full border border-blue-500/30 animate-pulse">
                <span class="w-2 h-2 bg-blue-400 rounded-full"></span> AWAITING ORDERS
            </div>

            <button onclick="confirmAttack()" id="fireBtn"
                class="bg-red-600 hover:bg-red-500 text-white font-bold px-8 py-2 rounded shadow-[0_0_15px_rgba(220,38,38,0.5)] disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed transition-all uppercase tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-crosshairs"></i> FIRE (0/0)
            </button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Target List -->
            <aside class="w-56 glass-panel border-r-0 border-t-0 border-b-0 border-l border-white/5 flex flex-col z-10">
                <div class="p-3 bg-slate-950/50 border-b border-white/5 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Targets</h3>
                    <span class="text-[10px] text-red-400 animate-pulse">LIVE FEED</span>
                </div>

                <div id="enemyList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>

                <div class="p-2 border-t border-white/5 bg-slate-900/50">
                    <button onclick="viewSelf()"
                        class="w-full bg-slate-800 hover:bg-slate-700 p-3 rounded text-xs font-bold text-blue-300 transition uppercase tracking-wide border border-slate-700 flex justify-center gap-2">
                        <i class="fa-regular fa-map"></i> View My Territory
                    </button>
                </div>
            </aside>

            <!-- Tactical Map -->
            <main class="flex-1 bg-slate-950 relative flex flex-col">
                <div class="absolute inset-0 pointer-events-none opacity-20"
                    style="background-image: linear-gradient(0deg, transparent 24%, rgba(56, 189, 248, .3) 25%, rgba(56, 189, 248, .3) 26%, transparent 27%, transparent 74%, rgba(56, 189, 248, .3) 75%, rgba(56, 189, 248, .3) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(56, 189, 248, .3) 25%, rgba(56, 189, 248, .3) 26%, transparent 27%, transparent 74%, rgba(56, 189, 248, .3) 75%, rgba(56, 189, 248, .3) 76%, transparent 77%, transparent); background-size: 50px 50px;">
                </div>

                <div id="targetName"
                    class="mx-auto mt-4 px-6 py-2 bg-black/60 rounded-full border border-slate-600 backdrop-blur-md text-sm font-mono text-slate-300 shadow-xl z-10 flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-slate-500"></span> SELECT TARGET
                </div>

                <div class="flex-1 flex justify-center items-center overflow-auto p-4 relative z-0">
                    <div id="battleGrid"
                        class="grid grid-cols-12 gap-px bg-slate-800 border-4 border-slate-700 shadow-2xl p-2 rounded-lg transition-all duration-300"
                        style="width: fit-content;"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        // For PRODUCTION (Vercel/Netlify): Paste your Firebase config below
        // For LOCAL DEVELOPMENT: Keep this null and create firebase-config.js file
        const INLINE_CONFIG = {
            apiKey: "AIzaSyDUffk0rriqkog1qqrcjKlgGvCh-s7Nyao",
            authDomain: "ydwg-island-battle.firebaseapp.com",
            projectId: "ydwg-island-battle",
            storageBucket: "ydwg-island-battle.firebasestorage.app",
            messagingSenderId: "488273932578",
            appId: "1:488273932578:web:852d684fd2962b61cdf57b"
        };

        let firebaseConfig;

        // Try to load from external file first (for local development)
        if (!INLINE_CONFIG) {
            try {
                const configModule = await import('./firebase-config.js');
                firebaseConfig = configModule.firebaseConfig;
            } catch (error) {
                console.error("‚ùå Firebase Config Missing!");
                alert("‚ö†Ô∏è Firebase Configuration Missing!\n\n" +
                    "FOR LOCAL DEVELOPMENT:\n" +
                    "1. Copy firebase-config.template.js\n" +
                    "2. Rename to firebase-config.js\n" +
                    "3. Paste your Firebase Config from Console\n" +
                    "4. Reload this page\n\n" +
                    "FOR DEPLOYMENT (Vercel/Netlify):\n" +
                    "1. Open index.html\n" +
                    "2. Find 'const INLINE_CONFIG = null'\n" +
                    "3. Replace with your Firebase config\n" +
                    "4. Commit and push to GitHub");
                throw new Error("Firebase configuration not found");
            }
        } else {
            firebaseConfig = INLINE_CONFIG;
        }

        const appId = 'island-battle-room-main';

        let app, auth, db;

        // Initialize Firebase
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.error("Firebase Config Invalid: Please check your firebase-config.js file.");
            alert("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå firebase-config.js ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Firebase Console ‡πÉ‡∏´‡∏°‡πà");
        }

        // --- Constants ---
        const ROWS = 8;
        const COLS = 12;
        const TOTAL_TILES = ROWS * COLS;
        const SHIPS_CONFIG = [4, 3, 2, 2, 1];
        const FIXED_ROOM_ID = "MAIN_LOBBY_V2";
        const ISLAND_LIMIT = 32;

        // --- State ---
        let currentUser = null;
        let currentGameId = FIXED_ROOM_ID;
        let playerRole = 'client';
        let gameData = null;
        let playersData = {};

        let setupGridData = Array(ROWS).fill().map(() => Array(COLS).fill(0));
        let setupObjects = { turrets: [], ships: [] };
        let currentTool = 'island';
        let currentShipIdx = 0;
        let isVertical = false;

        let selectedEnemyId = null;
        let pendingAttacks = [];
        let currentRoundAmmo = 3;

        // --- Auth & Init ---
        async function initAuth() {
            if (!auth) return;
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                alert("Login Failed: Did you enable Anonymous Auth in Firebase Console?");
            }
        }

        if (auth) {
            onAuthStateChanged(auth, (user) => { if (user) currentUser = user; });
            initAuth();
        }

        // --- UI Utils ---
        function showScreen(screenId) {
            document.querySelectorAll('body > div').forEach(d => d.classList.add('hidden-el'));
            document.getElementById(screenId).classList.remove('hidden-el');
        }

        window.showPasswordModal = () => {
            document.getElementById('passwordModal').classList.remove('hidden-el');
            document.getElementById('hostPasswordInput').value = '';
            document.getElementById('hostPasswordInput').focus();
        };

        window.closePasswordModal = () => {
            document.getElementById('passwordModal').classList.add('hidden-el');
        };

        window.verifyHost = () => {
            const pass = document.getElementById('hostPasswordInput').value;
            if (pass === 'admin1234') {
                closePasswordModal();
                joinGame('host');
            } else {
                alert("ACCESS DENIED: Invalid Security Clearance");
            }
        };

        // --- Logic: Join ---
        window.joinGame = async (role = 'client') => {
            if (!auth) return alert("Firebase not configured correctly.");
            if (!currentUser) return alert("Connecting to server... Please wait.");

            const username = document.getElementById('usernameInput').value.trim();
            if (!username) return alert("Identify yourself, soldier!");

            currentGameId = FIXED_ROOM_ID;
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId);

            try {
                const gameSnap = await getDoc(gameRef);

                if (!gameSnap.exists()) {
                    await setDoc(gameRef, { status: 'lobby', createdAt: Date.now(), round: 1, hostId: currentUser.uid });
                    playerRole = 'host'; // First player is always host initially
                } else {
                    const data = gameSnap.data();
                    if (role === 'host') {
                        // Force take over host role
                        await updateDoc(gameRef, { hostId: currentUser.uid });
                        playerRole = 'host';
                    } else {
                        playerRole = 'client';
                    }
                }

                // Update UI based on role immediately
                if (playerRole === 'host') {
                    document.getElementById('hostControls').classList.remove('hidden-el');
                    document.getElementById('clientWaiting').classList.add('hidden-el');
                } else {
                    document.getElementById('hostControls').classList.add('hidden-el');
                    document.getElementById('clientWaiting').classList.remove('hidden-el');
                }

                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players', currentUser.uid), {
                    name: username, id: currentUser.uid, status: 'joining', ammo: 3, bonusAmmo: 0, joinedAt: Date.now()
                });

                startLobbyListener();
                showScreen('lobbyScreen');
            } catch (e) {
                console.error("Join Error:", e);
                alert("Error joining game. Did you create the Firestore Database in Test Mode?");
            }
        };

        // --- Logic: Lobby ---
        function startLobbyListener() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players'), (snapshot) => {
                const list = document.getElementById('lobbyPlayerList');
                list.innerHTML = '';
                playersData = {};
                let count = 0;
                snapshot.forEach(doc => {
                    const p = doc.data();
                    playersData[p.id] = p;
                    count++;
                    const div = document.createElement('div');
                    div.className = "bg-slate-800/50 p-3 rounded border border-slate-700 flex items-center gap-3 hover:bg-slate-800 transition";
                    div.innerHTML = `
                        <div class="w-10 h-10 rounded bg-slate-700 flex items-center justify-center font-bold text-sm text-slate-300 border border-slate-600">${p.name.substring(0, 2).toUpperCase()}</div>
                        <div class="flex-1 min-w-0">
                            <div class="truncate font-bold text-slate-200 text-sm">${p.name}</div>
                            <div class="text-[10px] text-slate-500 font-mono uppercase">${p.id === currentUser.uid ? 'YOU' : 'ALLY'}</div>
                        </div>
                        ${p.status === 'ready' || p.status === 'alive' ? '<div class="px-2 py-1 bg-green-900/30 border border-green-800 rounded text-[10px] text-green-400 font-bold uppercase tracking-wider">Ready</div>' : '<div class="w-2 h-2 bg-slate-600 rounded-full"></div>'}
                    `;
                    list.appendChild(div);
                });
                document.getElementById('playerCount').innerText = count;
                checkGameStatus();
            });
        }

        function checkGameStatus() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), (docSnap) => {
                if (!docSnap.exists()) return;
                gameData = docSnap.data();
                const currentScreen = document.querySelector('body > div:not(.hidden-el)').id;

                if (gameData.status === 'setup' && currentScreen === 'lobbyScreen') startSetup();
                else if (gameData.status === 'battle' && (currentScreen === 'lobbyScreen' || currentScreen === 'setupScreen')) startBattle();
            });
        }

        window.startGame = async () => {
            const batch = writeBatch(db);
            Object.values(playersData).forEach(p => {
                batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players', p.id), {
                    status: 'setting_up', grid: [], ships: [], turrets: [], misses: [], islandHits: [], ammo: 3, bonusAmmo: 0
                });
            });
            batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), { status: 'setup', round: 1 });
            await batch.commit();
        };

        // --- Logic: Setup ---
        function startSetup() {
            showScreen('setupScreen');
            setupGridData = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            setupObjects = { turrets: [], ships: [] };
            currentShipIdx = 0;
            renderSetupGrid();
            updateSetupUI();

            const unsubReady = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players'), (snapshot) => {
                if (document.getElementById('setupScreen').classList.contains('hidden-el')) { unsubReady(); return; }
                let allReady = true, playerCount = 0;
                snapshot.forEach(d => {
                    playerCount++;
                    const s = d.data().status;
                    if (s !== 'ready' && s !== 'alive' && s !== 'eliminated') allReady = false;
                });
                if (playerRole === 'host' && allReady && playerCount > 0) {
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), { status: 'battle' });
                }
            });
        }

        function renderSetupGrid() {
            const grid = document.getElementById('setupGrid');
            grid.innerHTML = '';
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = `grid-cell rounded-sm ${getCellClass(r, c)}`;
                    cell.onclick = () => handleGridClick(r, c);
                    grid.appendChild(cell);
                }
            }
        }

        function getCellClass(r, c) {
            if (setupObjects.turrets.some(t => t.r === r && t.c === c)) return 'cell-turret';
            const ship = setupObjects.ships.find(s => {
                if (s.vertical) return c === s.c && r >= s.r && r < s.r + s.size;
                else return r === s.r && c >= s.c && c < s.c + s.size;
            });
            if (ship) return 'cell-ship';
            return setupGridData[r][c] === 1 ? 'cell-island' : 'cell-water';
        }

        window.toggleRotation = () => {
            isVertical = !isVertical;
            document.getElementById('rotateText').innerText = isVertical ? "Vert" : "Horz";
        };

        function handleGridClick(r, c) {
            if (currentTool === 'island') {
                if (setupGridData[r][c] === 1) {
                    setupGridData[r][c] = 0;
                    setupObjects.turrets = setupObjects.turrets.filter(t => t.r !== r || t.c !== c);
                } else {
                    const currentCount = setupGridData.flat().filter(x => x === 1).length;
                    if (currentCount >= ISLAND_LIMIT) return alert(`Maximum Territory Reached (${ISLAND_LIMIT})`);
                    setupGridData[r][c] = 1;
                }
            } else if (currentTool === 'water') {
                setupGridData[r][c] = 0;
                setupObjects.turrets = setupObjects.turrets.filter(t => t.r !== r || t.c !== c);
            } else if (currentTool === 'turret') {
                if (setupGridData[r][c] !== 1) return alert("Defense must be placed on Land");
                if (setupObjects.turrets.length >= 3) return alert("Max Turrets Deployed");
                if (isOccupied(r, c)) return;
                setupObjects.turrets.push({ r, c });
            } else if (currentTool === 'ship') {
                if (setupGridData[r][c] === 1) return alert("Ships require water placement");
                const size = SHIPS_CONFIG[currentShipIdx];
                if (canPlaceShip(r, c, size, isVertical)) {
                    setupObjects.ships.push({ r, c, size, vertical: isVertical, hits: Array(size).fill(false) });
                    currentShipIdx++;
                    if (currentShipIdx >= SHIPS_CONFIG.length) currentTool = null;
                } else {
                    alert("Invalid Position (Collision or Out of Bounds)");
                }
            }
            renderSetupGrid();
            updateSetupUI();
        }

        function isOccupied(r, c) {
            if (setupObjects.turrets.some(t => t.r === r && t.c === c)) return true;
            const ship = setupObjects.ships.find(s => {
                if (s.vertical) return c === s.c && r >= s.r && r < s.r + s.size;
                else return r === s.r && c >= s.c && c < s.c + s.size;
            });
            return !!ship;
        }

        function canPlaceShip(r, c, size, vert) {
            for (let i = 0; i < size; i++) {
                let nr = r + (vert ? i : 0);
                let nc = c + (vert ? 0 : i);
                if (nr >= ROWS || nc >= COLS) return false;
                if (setupGridData[nr][nc] === 1) return false;
                if (isOccupied(nr, nc)) return false;
            }
            return true;
        }

        window.setTool = (tool) => {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'border-blue-500', 'ring-2');
                b.classList.add('bg-slate-800', 'border-slate-700');
            });
            if (tool && tool !== 'ship') {
                const btn = document.getElementById(`tool-${tool}`);
                btn.classList.remove('bg-slate-800', 'border-slate-700');
                btn.classList.add('bg-slate-700', 'border-blue-500', 'ring-1', 'ring-blue-500');
            }
        };

        function updateSetupUI() {
            const shipContainer = document.getElementById('shipButtons');
            shipContainer.innerHTML = '';
            SHIPS_CONFIG.forEach((size, idx) => {
                const btn = document.createElement('button');
                const placed = idx < currentShipIdx;
                btn.className = `w-full text-left p-2 rounded text-xs border transition flex justify-between items-center ${placed ? 'bg-slate-900 border-slate-800 text-slate-600' : (idx === currentShipIdx ? 'bg-blue-900/30 border-blue-500 text-blue-300 shadow-[0_0_10px_rgba(59,130,246,0.3)]' : 'bg-slate-800 border-slate-700 text-slate-400')}`;
                btn.innerHTML = `<span><i class="fa-solid fa-ship"></i> Class-${size}</span> ${placed ? '<i class="fa-solid fa-check"></i>' : ''}`;
                if (idx === currentShipIdx && !placed) btn.onclick = () => { currentTool = 'ship'; window.setTool('ship'); };
                shipContainer.appendChild(btn);
            });

            const islandCount = setupGridData.flat().filter(x => x === 1).length;
            const validIsland = validateIslands(setupGridData);
            const turretsOk = setupObjects.turrets.length === 3;
            const shipsOk = setupObjects.ships.length === 5;
            const limitOk = islandCount === ISLAND_LIMIT;

            document.getElementById('islandCountStatus').querySelector('span:last-child').innerText = `${islandCount}/${ISLAND_LIMIT}`;
            document.getElementById('islandCountStatus').querySelector('span:last-child').className = `font-bold ${limitOk ? 'text-green-400' : 'text-slate-200'}`;

            document.getElementById('turretCountStatus').querySelector('span:last-child').innerText = `${setupObjects.turrets.length}/3`;
            document.getElementById('turretCountStatus').querySelector('span:last-child').className = `font-bold ${turretsOk ? 'text-green-400' : 'text-yellow-500'}`;

            document.getElementById('shipCountStatus').querySelector('span:last-child').innerText = `${setupObjects.ships.length}/5`;
            document.getElementById('shipCountStatus').querySelector('span:last-child').className = `font-bold ${shipsOk ? 'text-green-400' : 'text-blue-400'}`;

            const readyBtn = document.getElementById('readyBtn');
            if (validIsland && turretsOk && shipsOk && islandCount > 0) {
                readyBtn.disabled = false;
                readyBtn.className = "bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded shadow-lg shadow-green-900/50 font-bold transition-all text-sm uppercase tracking-wide transform hover:scale-105";
                readyBtn.innerHTML = "<i class='fa-solid fa-check'></i> Ready to Deploy";
            } else {
                readyBtn.disabled = true;
                readyBtn.className = "bg-slate-800 text-slate-500 px-6 py-2 rounded border border-slate-700 cursor-not-allowed font-bold text-sm uppercase tracking-wide";
                readyBtn.innerText = "Incomplete Setup";
            }
        }

        function validateIslands(grid) {
            let startR = -1, startC = -1, count = 0;
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (grid[r][c] === 1) {
                        if (startR === -1) { startR = r; startC = c; }
                        count++;
                    }
                }
            }
            if (count === 0) return false;
            let visited = new Set();
            let queue = [`${startR},${startC}`];
            visited.add(`${startR},${startC}`);
            let found = 0;
            while (queue.length > 0) {
                const [cr, cc] = queue.shift().split(',').map(Number);
                found++;
                [[0, 1], [0, -1], [1, 0], [-1, 0]].forEach(d => {
                    let nr = cr + d[0], nc = cc + d[1];
                    if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS && grid[nr][nc] === 1 && !visited.has(`${nr},${nc}`)) {
                        visited.add(`${nr},${nc}`); queue.push(`${nr},${nc}`);
                    }
                });
            }
            return found === count;
        }

        window.submitBoard = async () => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players', currentUser.uid), {
                    grid: setupGridData.flat(), turrets: setupObjects.turrets, ships: setupObjects.ships, status: 'ready'
                });

                // Show Waiting Room instead of destroying UI
                document.getElementById('setupWaitingRoom').classList.remove('hidden-el');

                // Host Controls Logic
                if (playerRole === 'host') {
                    document.getElementById('setupHostControls').classList.remove('hidden-el');
                    document.getElementById('setupClientMessage').classList.add('hidden-el');
                } else {
                    document.getElementById('setupHostControls').classList.add('hidden-el');
                    document.getElementById('setupClientMessage').classList.remove('hidden-el');
                }

                // Start listening for readiness
                monitorSetupReadiness();
            };

            function monitorSetupReadiness() {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players'), (snapshot) => {
                    const list = document.getElementById('setupPlayerList');
                    list.innerHTML = '';
                    let allReady = true;
                    let playerCount = 0;

                    snapshot.forEach(doc => {
                        const p = doc.data();
                        if (p.status === 'joining') return; // Skip players who haven't started setup
                        playerCount++;

                        const isReady = p.status === 'ready' || p.status === 'alive';
                        if (!isReady) allReady = false;

                        const div = document.createElement('div');
                        div.className = `p-3 rounded border flex items-center justify-between ${isReady ? 'bg-green-900/20 border-green-500/30' : 'bg-slate-800 border-slate-700'}`;
                        div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded flex items-center justify-center font-bold text-xs ${isReady ? 'bg-green-500 text-white' : 'bg-slate-700 text-slate-400'}">
                                ${isReady ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-wrench"></i>'}
                            </div>
                            <span class="font-bold text-slate-200 text-sm">${p.name}</span>
                        </div>
                        <span class="text-[10px] font-mono uppercase tracking-wider ${isReady ? 'text-green-400' : 'text-yellow-500'}">
                            ${isReady ? 'READY FOR BATTLE' : 'CONFIGURING TERRITORY'}
                        </span>
                    `;
                        list.appendChild(div);
                    });

                    // Host Button Logic
                    const startBtn = document.getElementById('forceStartBtn');
                    if (playerRole === 'host') {
                        if (allReady && playerCount > 0) {
                            startBtn.disabled = false;
                            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            startBtn.classList.add('animate-pulse');
                        } else {
                            startBtn.disabled = true;
                            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            startBtn.classList.remove('animate-pulse');
                        }
                    }
                });
            }

            window.initiateBattleSequence = async () => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), { status: 'battle' });
            };

            // --- Logic: Battle ---
            function startBattle() {
                // Hide Setup Screen completely
                document.getElementById('setupScreen').classList.add('hidden-el');
                showScreen('battleScreen');
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players', currentUser.uid), { status: 'alive' });

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players'), (snap) => {
                    const list = document.getElementById('enemyList');
                    list.innerHTML = '';
                    playersData = {};
                    snap.forEach(d => {
                        const p = d.data();
                        playersData[p.id] = p;
                        if (p.id === currentUser.uid) {
                            currentRoundAmmo = p.ammo;
                            document.getElementById('myAmmo').innerText = p.ammo;
                            document.getElementById('bonusAmmo').innerText = p.bonusAmmo;
                            updateFireButton();
                            if (!selectedEnemyId) renderBattleGrid(currentUser.uid);
                        } else if (p.status === 'alive') {
                            const btn = document.createElement('button');
                            btn.className = `w-full text-left p-3 rounded mb-2 transition flex justify-between items-center shadow-sm border ${selectedEnemyId === p.id ? 'bg-red-900/40 border-red-500 text-white shadow-[0_0_10px_rgba(239,68,68,0.3)]' : 'bg-slate-800 border-slate-700 text-slate-300 hover:bg-slate-700 hover:border-slate-600'}`;
                            btn.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${selectedEnemyId === p.id ? 'bg-red-500 animate-pulse' : 'bg-slate-500'}"></span>
                                <span class="font-bold text-sm">${p.name}</span>
                            </div>
                            <i class="fa-solid fa-crosshairs ${selectedEnemyId === p.id ? 'text-red-400' : 'text-slate-500'}"></i>`;
                            btn.onclick = () => selectEnemy(p.id, p.name);
                            list.appendChild(btn);
                        } else if (p.status === 'eliminated') {
                            const div = document.createElement('div');
                            div.className = "w-full text-left p-2 rounded mb-1 bg-slate-900/50 border border-slate-800 text-slate-600 text-xs italic flex justify-between";
                            div.innerHTML = `<span>üíÄ ${p.name}</span> <span>KIA</span>`;
                            list.appendChild(div);
                        }
                    });
                    if (selectedEnemyId) renderBattleGrid(selectedEnemyId);
                    else renderBattleGrid(currentUser.uid);
                });

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), (docSnap) => {
                    const data = docSnap.data();
                    if (data.round !== parseInt(document.getElementById('roundDisplay').innerText)) {
                        document.getElementById('roundDisplay').innerText = data.round;
                        pendingAttacks = [];
                        updateFireButton();
                        const fireBtn = document.getElementById('fireBtn');
                        fireBtn.innerHTML = `<i class="fa-solid fa-crosshairs"></i> FIRE (0/${currentRoundAmmo})`;
                        fireBtn.disabled = false;
                        document.getElementById('phaseStatus').innerHTML = '<span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span> SELECT TARGETS';
                    }
                });
            }

            window.selectEnemy = (id, name) => {
                selectedEnemyId = id;
                const badge = document.getElementById('targetName');
                badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> LOCK: ${name}`;
                badge.className = "mx-auto mt-4 px-6 py-2 bg-red-900/80 rounded-full border border-red-500 text-sm font-mono text-white shadow-[0_0_20px_rgba(220,38,38,0.5)] z-10 flex items-center gap-3";
                renderBattleGrid(id);
                updateFireButton();
            };

            window.viewSelf = () => {
                selectedEnemyId = null;
                const badge = document.getElementById('targetName');
                badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-blue-500"></span> TERRITORY STATUS`;
                badge.className = "mx-auto mt-4 px-6 py-2 bg-blue-900/80 rounded-full border border-blue-500 text-sm font-mono text-white shadow-[0_0_20px_rgba(37,99,235,0.5)] z-10 flex items-center gap-3";
                renderBattleGrid(currentUser.uid);
            };

            function renderBattleGrid(targetId) {
                const gridEl = document.getElementById('battleGrid');
                gridEl.innerHTML = '';
                const targetData = playersData[targetId];
                if (!targetData) return;
                const flatGrid = targetData.grid || [];
                if (flatGrid.length === 0) return;

                const misses = targetData.misses || [];
                const islandHits = targetData.islandHits || [];
                const isSelf = targetId === currentUser.uid;

                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        const idx = r * COLS + c;
                        const cell = document.createElement('div');
                        let baseClass = 'cell-water';
                        let overlayClass = '';

                        if (isSelf) {
                            if (flatGrid[idx] === 1) baseClass = 'cell-island';
                            const ship = targetData.ships.find(s => {
                                if (s.vertical) return c === s.c && r >= s.r && r < s.r + s.size;
                                else return r === s.r && c >= s.c && c < s.c + s.size;
                            });
                            if (ship) baseClass = 'cell-ship';
                            if (targetData.turrets.some(t => t.r === r && t.c === c)) baseClass = 'cell-turret';
                        }

                        if (misses.some(m => m.r === r && m.c === c)) overlayClass = 'cell-miss';
                        if (islandHits.some(h => h.r === r && h.c === c)) overlayClass = 'cell-island-hit';
                        targetData.ships.forEach(s => {
                            for (let i = 0; i < s.size; i++) {
                                let sr = s.r + (s.vertical ? i : 0);
                                let sc = s.c + (s.vertical ? 0 : i);
                                if (sr === r && sc === c && s.hits[i]) overlayClass = 'cell-hit';
                            }
                        });

                        if (!isSelf && pendingAttacks.some(a => a.targetId === targetId && a.r === r && a.c === c)) {
                            cell.classList.add('ring-2', 'ring-red-500', 'z-20', 'bg-red-500/40');
                            cell.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-red-500 opacity-50"><i class="fa-solid fa-crosshairs text-[10px]"></i></div>';
                        }
                        cell.className = `grid-cell rounded-sm ${overlayClass || baseClass}`;
                        if (!isSelf && !overlayClass) cell.onclick = () => toggleTarget(targetId, r, c);
                        gridEl.appendChild(cell);
                    }
                }
            }

            function toggleTarget(targetId, r, c) {
                const exists = pendingAttacks.find(a => a.targetId === targetId && a.r === r && a.c === c);
                if (exists) pendingAttacks = pendingAttacks.filter(a => a !== exists);
                else if (pendingAttacks.length < currentRoundAmmo) pendingAttacks.push({ targetId, r, c });
                renderBattleGrid(targetId);
                updateFireButton();
            }

            function updateFireButton() {
                const btn = document.getElementById('fireBtn');
                btn.innerHTML = `<i class="fa-solid fa-crosshairs"></i> FIRE (${pendingAttacks.length}/${currentRoundAmmo})`;
                btn.disabled = pendingAttacks.length === 0;
                if (pendingAttacks.length > 0) {
                    btn.classList.add('animate-pulse');
                } else {
                    btn.classList.remove('animate-pulse');
                }
            }

            window.confirmAttack = async () => {
                if (pendingAttacks.length === 0) return;
                const btn = document.getElementById('fireBtn');
                btn.disabled = true;
                btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> TRANSMITTING...`;
                document.getElementById('phaseStatus').innerHTML = '<span class="text-yellow-400">WAITING FOR RESOLUTION</span>';
                const batch = writeBatch(db);
                const moveRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'moves', `${gameData.round}_${currentUser.uid}`);
                batch.set(moveRef, { playerId: currentUser.uid, attacks: pendingAttacks, round: gameData.round, timestamp: Date.now() });
                batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players', currentUser.uid), { moveSubmitted: true });
                await batch.commit();
                if (playerRole === 'host') monitorMovesAndResolve();
            };

            function monitorMovesAndResolve() {
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'moves'), async (snap) => {
                    const currentRoundMoves = snap.docs.filter(d => d.data().round === gameData.round);
                    const alivePlayers = Object.values(playersData).filter(p => p.status === 'alive');
                    if (currentRoundMoves.length >= alivePlayers.length && alivePlayers.length > 0) {
                        unsub();
                        resolveRound(currentRoundMoves.map(d => d.data()));
                    }
                });
            }

            async function resolveRound(allMoves) {
                const batch = writeBatch(db);
                let updates = {};
                allMoves.forEach(move => {
                    move.attacks.forEach(att => {
                        const target = playersData[att.targetId];
                        if (!target || target.status !== 'alive') return;
                        if (!updates[att.targetId]) updates[att.targetId] = { misses: target.misses || [], islandHits: target.islandHits || [], ships: target.ships, bonusAmmo: 0 };

                        const tData = updates[att.targetId];
                        const r = att.r, c = att.c;
                        const flatIdx = r * COLS + c;
                        let hitShip = false;
                        tData.ships.forEach(ship => {
                            for (let i = 0; i < ship.size; i++) {
                                let sr = ship.r + (ship.vertical ? i : 0);
                                let sc = ship.c + (ship.vertical ? 0 : i);
                                if (sr === r && sc === c) { ship.hits[i] = true; hitShip = true; }
                            }
                        });

                        if (!hitShip) {
                            if (target.grid[flatIdx] === 1) { tData.islandHits.push({ r, c }); tData.bonusAmmo++; }
                            else tData.misses.push({ r, c });
                        }
                    });
                });

                Object.keys(updates).forEach(pid => {
                    const u = updates[pid];
                    let allSunk = true;
                    u.ships.forEach(s => { if (s.hits.includes(false)) allSunk = false; });
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players', pid), {
                        ships: u.ships, misses: u.misses, islandHits: u.islandHits, bonusAmmo: u.bonusAmmo,
                        ammo: 3 + u.bonusAmmo, status: allSunk ? 'eliminated' : 'alive', moveSubmitted: false
                    });
                });

                Object.keys(playersData).forEach(pid => {
                    if (!updates[pid] && playersData[pid].status === 'alive') {
                        batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId, 'players', pid), { ammo: 3, bonusAmmo: 0, moveSubmitted: false });
                    }
                });

                batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId), { round: increment(1) });
                await batch.commit();
            }
    </script>
</body>

</html>
