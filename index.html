<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Island Battle Royale</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Kanit', 'sans-serif'],
                        mono: ['Share Tech Mono', 'monospace'],
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .hidden-el {
                display: none !important;
            }
            .glass-panel {
                @apply bg-slate-900/80 backdrop-blur-md border border-slate-700/50;
            }
            .grid-cell {
                width: 2.5rem;
                height: 2.5rem;
                @apply bg-blue-900/30 border border-blue-800/30 transition-all duration-200 cursor-pointer hover:bg-blue-800/50 relative;
            }
            .cell-water { @apply bg-slate-900/50; }
            .cell-island { 
                @apply bg-emerald-900/80 border-emerald-700 shadow-[inset_0_0_10px_rgba(16,185,129,0.2)];
                background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23064e3b' fill-opacity='0.4' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            }
            .cell-ship { 
                @apply bg-blue-900/60 border-blue-500/50 shadow-[inset_0_0_10px_rgba(59,130,246,0.3)];
                background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(59,130,246,0.1) 5px, rgba(59,130,246,0.1) 10px);
            }
            .cell-turret { 
                @apply bg-orange-900/60 border-orange-500/50;
                position: relative;
            }
            .cell-turret::after {
                content: '\f132'; /* fa-shield-halved */
                font-family: "Font Awesome 6 Free";
                font-weight: 900;
                @apply absolute inset-0 flex items-center justify-center text-orange-500 text-xs;
            }
            .cell-hit { @apply bg-red-900/80 border-red-500 animate-pulse; }
            .cell-hit::after {
                content: '\f06d'; /* fa-fire */
                font-family: "Font Awesome 6 Free";
                font-weight: 900;
                @apply absolute inset-0 flex items-center justify-center text-red-500 text-sm animate-bounce;
            }
            .cell-miss { @apply bg-slate-800/80; }
            .cell-miss::after {
                content: '\f00d'; /* fa-xmark */
                font-family: "Font Awesome 6 Free";
                font-weight: 900;
                @apply absolute inset-0 flex items-center justify-center text-slate-600 text-lg;
            }
            .cell-island-hit { @apply bg-yellow-900/80 border-yellow-500; }
            .cell-island-hit::after {
                content: '\f0e7'; /* fa-bolt */
                font-family: "Font Awesome 6 Free";
                font-weight: 900;
                @apply absolute inset-0 flex items-center justify-center text-yellow-500 text-sm animate-pulse;
    <!-- Login Screen -->
    <div id="loginScreen" class="flex flex-col items-center justify-center h-full relative overflow-hidden">
        <div
            class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-blue-900/20 via-slate-950 to-slate-950">
        </div>

        <div class="relative z-10 text-center space-y-8 p-8 max-w-md w-full">
            <div class="mb-12 animate-bounce">
                <div
                    class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto shadow-[0_0_30px_rgba(59,130,246,0.3)] border border-slate-700">
                    <i class="fa-solid fa-ship text-4xl text-blue-500"></i>
                </div>
            </div>

            <div>
                <h1
                    class="text-5xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2 drop-shadow-lg">
                    ISLAND BATTLE
                </h1>
                <p class="text-slate-500 font-mono text-sm tracking-[0.3em] uppercase">Tactical Naval Warfare</p>
            </div>

            <div
                class="glass-panel p-8 rounded-2xl shadow-2xl space-y-6 transform transition-all hover:scale-[1.02] duration-300">
                <div class="space-y-2 text-left">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Identify
                        Yourself</label>
                    <input type="text" id="usernameInput"
                        class="w-full bg-slate-900/80 p-4 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 border border-slate-700 text-lg placeholder-slate-600 transition-all text-center font-mono"
                        placeholder="ENTER CALLSIGN">
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="joinGame('client')"
                        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-4 rounded-lg shadow-lg shadow-blue-900/50 transition-all transform hover:translate-y-px hover:shadow-xl flex items-center justify-center gap-2 group-hover:tracking-wide">
                        <span>JOIN OPERATION</span> <i class="fa-solid fa-chevron-right text-xs"></i>
                    </button>
                    <button onclick="showPasswordModal()"
                        class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 rounded-lg border border-slate-700 transition-all flex items-center justify-center gap-2 text-sm">
                        <i class="fa-solid fa-user-shield"></i> <span>ADMIRAL LOGIN</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal"
        class="hidden-el fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl shadow-2xl w-full max-w-xs transform transition-all scale-100">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i
                    class="fa-solid fa-key text-yellow-500"></i> Security Clearance</h3>
            <input type="password" id="hostPasswordInput"
                class="w-full bg-slate-900/80 p-3 rounded text-white border border-slate-700 mb-4 focus:outline-none focus:border-blue-500 font-mono tracking-widest"
                placeholder="ENTER PASSCODE">
            <div class="flex gap-2">
                <button onclick="closePasswordModal()"
                    class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded font-bold text-sm">CANCEL</button>
                <button onclick="verifyHost()"
                    class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-sm">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="hidden-el flex flex-col items-center min-h-screen p-4 md:p-8">
        <div class="w-full max-w-4xl">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-white">COMMAND CENTER</h2>
                    <p class="text-slate-400 text-sm">Waiting for deployment...</p>
                </div>
                <div
                    class="glass-panel px-4 py-2 rounded-full text-xs font-mono text-green-400 flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ONLINE
                    <button onclick="logout()" class="ml-2 text-slate-500 hover:text-red-400 transition"><i
                            class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl border-t-4 border-t-blue-500 shadow-2xl mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-300 flex items-center gap-2"><i class="fa-solid fa-users"></i>
                        ACTIVE UNITS</h3>

                    <div class="flex items-center gap-2">
                        <button onclick="location.reload()"
                            class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs text-slate-300 transition"
                            title="Manual Refresh">
                            <i class="fa-solid fa-rotate-right"></i>
                        </button>
                        <span class="bg-slate-800 px-3 py-1 rounded text-xs font-mono text-slate-400">COUNT: <span
                                id="playerCount" class="text-white">0</span></span>
                    </div>
                </div>
                <div id="lobbyPlayerList"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[400px] overflow-y-auto pr-2">
                    <!-- Players -->
                </div>
            </div>

            <div id="hostControls" class="hidden-el text-center animate-fade-in-up">
                <button onclick="startGameSetup()"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 px-12 rounded-full shadow-lg shadow-emerald-900/50 transition-all transform hover:scale-105 flex items-center gap-3 mx-auto">
                    <i class="fa-solid fa-compass-drafting"></i> INITIATE DEPLOYMENT
                </button>
                <p class="mt-4 text-slate-500 text-sm">Only the Admiral can start the operation.</p>
            </div>

            <div id="clientWaiting" class="hidden-el text-center py-8">
                <div
                    class="inline-flex items-center gap-3 text-slate-400 bg-slate-900/50 px-6 py-3 rounded-full border border-slate-800">
                    <i class="fa-solid fa-spinner fa-spin text-blue-500"></i>
                    <span>Awaiting Admiral's Orders...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="hidden-el flex flex-col h-screen bg-slate-950">
        <header
            class="bg-slate-900/80 backdrop-blur border-b border-slate-800 p-4 flex justify-between items-center z-20">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-compass-drafting text-white"></i>
                </div>
                <div>
                    <h2 class="font-bold text-white leading-tight">DEPLOYMENT PHASE</h2>
                    <p class="text-xs text-slate-400 font-mono">SECURE YOUR TERRITORY</p>
                </div>
            </div>
            <button onclick="submitBoard()"
                class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-all flex items-center gap-2">
                <i class="fa-solid fa-check"></i> CONFIRM LAYOUT
            </button>
        </header>

        <div class="flex flex-1 overflow-hidden relative">
            <!-- Tools Sidebar -->
            <aside
                class="w-80 bg-slate-900 border-r border-slate-800 p-6 flex flex-col gap-6 overflow-y-auto z-20 shadow-xl">

                <!-- Island Tool -->
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Terrain</h3>
                        <span id="islandCountDisplay" class="text-[10px] font-mono text-emerald-500">0/32</span>
                    </div>
                    <button id="btn-island" onclick="selectTool('island')"
                        class="tool-btn w-full bg-slate-800 hover:bg-slate-700 p-4 rounded-xl border border-slate-700 transition-all text-left group ring-2 ring-white">
                        <div class="flex items-center gap-3 mb-2">
                            <div
                                class="w-8 h-8 rounded bg-emerald-900/50 border border-emerald-500/30 flex items-center justify-center text-emerald-500">
                                <i class="fa-solid fa-mountain"></i>
                            </div>
                            <span class="font-bold text-slate-200 group-hover:text-white">ISLAND</span>
                        </div>
                        <p class="text-xs text-slate-500">Place land masses to block enemy fire.</p>
                    </button>
                </div>

                <!-- Ship Tool -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Fleet</h3>
                    <div id="fleetList" class="space-y-2">
                        <!-- Dynamic Fleet List -->
                    </div>
                    <button id="btn-rotate" onclick="toggleOrientation()"
                        class="w-full py-2 bg-slate-800 border border-slate-700 rounded text-xs font-bold text-slate-400 hover:text-white hover:bg-slate-700 transition">
                        <i class="fa-solid fa-arrow-right"></i> HORIZONTAL
                    </button>
                </div>

                <!-- Turret Tool -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Defense</h3>
                    <button id="btn-turret" onclick="selectTool('turret')"
                        class="tool-btn w-full bg-slate-800 hover:bg-slate-700 p-4 rounded-xl border border-slate-700 transition-all text-left group">
                        <div class="flex items-center gap-3 mb-2">
                            <div
                                class="w-8 h-8 rounded bg-orange-900/50 border border-orange-500/30 flex items-center justify-center text-orange-500">
                                <i class="fa-solid fa-shield-halved"></i>
                            </div>
                            <span class="font-bold text-slate-200 group-hover:text-white">TURRET</span>
                        </div>
                        <p class="text-xs text-slate-500">Defensive structures.</p>
                    </button>
                </div>

                <div class="mt-auto pt-6 border-t border-slate-800 flex gap-2">
                    <button onclick="undoLastAction()" class="flex-1 py-2 bg-yellow-900/20 text-yellow-500 border border-yellow-900/50 rounded hover:bg-yellow-900/40 text-xs font-bold transition">UNDO</button>
                    <button onclick="clearBoard()"
                        class="flex-1 py-2 bg-red-900/20 text-red-500 border border-red-900/50 rounded hover:bg-red-900/40 text-xs font-bold transition">CLEAR</button>
                    <button onclick="randomizeBoard()"
                        class="flex-1 py-2 bg-slate-800 text-slate-400 border border-slate-700 rounded hover:bg-slate-700 text-xs font-bold transition">AUTO</button>
                </div>
            </aside>

            <!-- Main Grid Area -->
            <main class="flex-1 bg-slate-950 relative flex justify-center items-center p-4 overflow-auto">
                <!-- Grid Background Effect -->
                <div class="absolute inset-0 opacity-10"
                    style="background-image: radial-gradient(#3b82f6 1px, transparent 1px); background-size: 20px 20px;">
                </div>

                <div id="setupGrid"
                    class="relative z-10 grid grid-cols-12 gap-px bg-slate-800 border-2 border-slate-700 shadow-2xl p-2 rounded-lg backdrop-blur-sm"
                    style="width: fit-content;">
                    <!-- Cells generated by JS -->
                </div>
            </main>
        </div>

        <!-- Setup Waiting Room (Overlay) -->
        <div id="setupWaitingRoom"
            class="hidden-el absolute inset-0 z-50 bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center p-8">
            <div class="w-full max-w-2xl">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">DEPLOYMENT STAGING AREA</h2>
                    <p class="text-slate-400">Waiting for all fleets to report readiness...</p>
                </div>

                <div class="glass-panel p-6 rounded-xl border border-slate-700 shadow-2xl mb-8">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-4 mb-4">
                        <h3 class="font-bold text-slate-300">Fleet Status</h3>

                        <div class="flex items-center gap-2">
                            <button onclick="location.reload()"
                                class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs text-slate-300 transition"
                                title="Manual Refresh">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                            <div class="text-xs font-mono text-slate-500">LIVE FEED</div>
                        </div>
                    </div>
                    <div id="setupPlayerList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Player Status Items -->
                    </div>
                </div>

                <div id="setupHostControls" class="hidden-el flex justify-center">
                    <button onclick="initiateBattleSequence()" id="forceStartBtn" disabled
                        class="bg-green-600 hover:bg-green-500 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-bold py-4 px-12 rounded-full shadow-lg transition-all flex items-center gap-3">
                        <i class="fa-solid fa-meteor"></i> INITIATE BATTLE SEQUENCE
                    </button>
                </div>
                <div id="setupClientMessage" class="text-center text-slate-500 animate-pulse mt-4">
                    <i class="fa-solid fa-hourglass-half"></i> Awaiting Commander's Order...
                </div>
            </div>
        </div>
    </div>

    <!-- Battle Phase -->
    <div id="battleScreen" class="hidden-el flex flex-col h-screen overflow-hidden bg-slate-900">
        <!-- Battle Header -->
        <header class="bg-slate-950 border-b border-slate-800 p-3 flex justify-between items-center z-30 shadow-lg">
            <div class="flex items-center gap-4">
                <div class="text-xs font-mono text-slate-500">
                    <div class="text-slate-300 font-bold">OPERATION ISLAND</div>
                    <div>SECURE CHANNEL #808</div>
                </div>
                <div class="h-8 w-px bg-slate-800"></div>
                <div class="flex items-center gap-3">
                    <div class="text-center">
                        <div class="text-[10px] text-slate-500 font-bold uppercase">Round</div>
                        <div id="roundDisplay" class="text-xl font-black text-white leading-none">1</div>
                    </div>
                    <div id="phaseStatus"
                        class="px-3 py-1 bg-blue-900/30 border border-blue-800 rounded text-xs font-bold text-blue-400 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span> SELECT TARGETS
                    </div>
                </div>
            </div>

            <button id="hostResetBtn" onclick="resetGame()"
                class="hidden-el px-3 py-1 bg-slate-800 hover:bg-red-900/50 border border-slate-700 hover:border-red-500 text-slate-400 hover:text-red-400 rounded text-xs font-bold transition flex items-center gap-2 mr-4"><i
                    class="fa-solid fa-power-off"></i> RESET</button>
            onclick="confirmAttack()" disabled
            class="bg-red-600 hover:bg-red-500 disabled:bg-slate-800 disabled:text-slate-600 text-white font-bold py-2
            px-8 rounded shadow-lg shadow-red-900/50 transition-all flex items-center gap-2">
            <i class="fa-solid fa-crosshairs"></i> FIRE (0/3)
            </button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Radar / Targets -->
            <aside class="w-72 bg-slate-900 border-r border-slate-800 flex flex-col z-20">
                <div class="p-4 border-b border-slate-800 bg-slate-900/50">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Targets</h3>
                    <div id="enemyList" class="space-y-2 overflow-y-auto max-h-[40vh]">
                        <!-- Enemy List -->
                    </div>
                </div>

                <div class="p-4 flex-1 bg-slate-950/30">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Status</h3>
                    <div class="space-y-2">
                        <div
                            class="flex justify-between items-center p-2 bg-slate-800/50 rounded border border-slate-700/50">
                            <span class="text-sm text-slate-400">Ammo</span>
                            <span id="myAmmo" class="font-mono font-bold text-yellow-400">3</span>
                        </div>
                        <div
                            class="flex justify-between items-center p-2 bg-slate-800/50 rounded border border-slate-700/50">
                            <span class="text-sm text-slate-400">Bonus</span>
                            <span id="bonusAmmo" class="font-mono font-bold text-green-400">0</span>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-slate-800">
                    <button onclick="viewSelf()"
                        class="w-full py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 rounded font-bold text-xs flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-satellite"></i> VIEW MY TERRITORY
                    </button>
                </div>
            </aside>

            <!-- Main Battle View -->
            <main class="flex-1 bg-slate-950 relative flex flex-col">
                <!-- Grid Container -->
                <div class="flex-1 flex justify-center items-center relative overflow-auto p-8">
                    <!-- Grid Background -->
                    <div class="absolute inset-0 opacity-20"
                        style="background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px); background-size: 40px 40px;">
                    </div>

                    <div class="relative z-10">
                        <div id="targetName"
                            class="mx-auto mb-4 px-6 py-2 bg-blue-900/80 rounded-full border border-blue-500 text-sm font-mono text-white shadow-[0_0_20px_rgba(37,99,235,0.5)] flex items-center gap-3 w-fit">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span> TERRITORY STATUS
                        </div>

                        <div id="battleGrid"
                            class="grid grid-cols-12 gap-px bg-slate-800 border-4 border-slate-700 shadow-2xl p-2 rounded-lg transition-all duration-300"
                            style="width: fit-content;"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, writeBatch, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDUffk0rriqkog1qqrcjKlgGvCh-s7Nyao",
            authDomain: "ydwg-island-battle.firebaseapp.com",
            projectId: "ydwg-island-battle",
            storageBucket: "ydwg-island-battle.firebasestorage.app",
            messagingSenderId: "488273932578",
            appId: "1:488273932578:web:852d684fd2962b61cdf57b"
        };

        let app, auth, db;
        const appId = 'island-battle-room-main';

        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else if (window.INLINE_CONFIG) {
                app = initializeApp(window.INLINE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.warn("Firebase config missing.");
            }
        } catch (e) { console.error("Firebase init error:", e); }

        // --- State ---
        const CONSTANTS = {
            ROWS: 8, COLS: 12, SHIPS_CONFIG: [4, 3, 2, 2, 1], FIXED_ROOM_ID: "MAIN_LOBBY_V2", ISLAND_LIMIT: 32
        };
        const state = {
            currentUser: null, currentGameId: "MAIN_LOBBY_V2", playerRole: 'client', gameData: null, playersData: {},
            setupGridData: Array(8).fill().map(() => Array(12).fill(0)), setupObjects: { turrets: [], ships: [] },
            currentTool: 'island', currentShipIdx: 0, isVertical: false,
            selectedEnemyId: null, pendingAttacks: [], currentRoundAmmo: 3
        };

        // --- UI Functions ---

        window.logout = () => {
            if (confirm("Abort operation and return to HQ?")) {
                auth.signOut().then(() => location.reload());
            }
        };

        function renderFleetSidebar() {
            const list = document.getElementById("fleetList");
            if (!list) return;
            list.innerHTML = "";

            CONSTANTS.SHIPS_CONFIG.forEach((size, idx) => {
                const isPlaced = idx < state.currentShipIdx;
                const isActive = idx === state.currentShipIdx;
                const name = getShipName(size);

                const btn = document.createElement("button");
                btn.className = `w-full p-3 rounded-lg border text-left transition flex items-center justify-between ${isActive
                        ? "bg-blue-900/40 border-blue-500 ring-1 ring-blue-500"
                        : isPlaced
                            ? "bg-slate-800/50 border-slate-700 opacity-50"
                            : "bg-slate-800 border-slate-700 opacity-70"
                    }`;

                if (isActive) btn.onclick = () => selectTool("ship");

                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded flex items-center justify-center ${isActive ? "bg-blue-600 text-white" : "bg-slate-700 text-slate-400"}">
                            <i class="fa-solid fa-ship"></i>
                        </div>
                        <div>
                            <div class="text-xs font-bold ${isActive ? "text-white" : "text-slate-400"}">${name}</div>
                            <div class="text-[10px] font-mono ${isActive ? "text-blue-300" : "text-slate-500"}">${size} TILES</div>
                        </div>
                    </div>
                    ${isPlaced ? "<i class=\"fa-solid fa-check text-green-500\"></i>" : ""}
                `;
                list.appendChild(btn);
            });
        }


        window.kickPlayer = async (pid, name) => {
            if (!confirm(`Confirm discharge of ${name}?`)) return;
            try {
                await deleteDoc(doc(db, "artifacts", appId, "public", "data", "games", state.currentGameId, "players", pid));
            } catch (e) { console.error("Kick error:", e); alert("Failed to kick: " + e.message); }
        };

        window.resetGame = async () => {
            if (!confirm("?? WARNING: This will RESET the operation for ALL units. Confirm?")) return;
            const batch = writeBatch(db);
            batch.update(doc(db, "artifacts", appId, "public", "data", "games", state.currentGameId), { status: "lobby", round: 1 });
            Object.keys(state.playersData).forEach(pid => {
                batch.update(doc(db, "artifacts", appId, "public", "data", "games", state.currentGameId, "players", pid), {
                    status: "joining", grid: [], ships: [], turrets: [], misses: [], islandHits: [], ammo: 3, bonusAmmo: 0, moveSubmitted: false
                });
            });
            await batch.commit();
            location.reload();
        };






        function showScreen(screenId) {
            document.querySelectorAll('body > div').forEach(d => d.classList.add('hidden-el'));
            const screen = document.getElementById(screenId);
            if (screen) screen.classList.remove('hidden-el');
        }

        window.showPasswordModal = () => {
            document.getElementById('passwordModal').classList.remove('hidden-el');
            document.getElementById('hostPasswordInput').value = '';
            document.getElementById('hostPasswordInput').focus();
        };

        window.logout = () => {
            if (confirm("Abort operation and return to HQ?")) {
                auth.signOut().then(() => location.reload());
            }
        };

        window.closePasswordModal = () => {
            document.getElementById('passwordModal').classList.add('hidden-el');
        };

        function updateFireButton() {
            const btn = document.getElementById('fireBtn');
            if (!btn) return;
            btn.innerHTML = `<i class="fa-solid fa-crosshairs"></i> FIRE (${state.pendingAttacks.length}/${state.currentRoundAmmo})`;
            btn.disabled = state.pendingAttacks.length === 0;
            if (state.pendingAttacks.length > 0) btn.classList.add('animate-pulse');
            else btn.classList.remove('animate-pulse');
        }

        function renderBattleGrid(targetId, onCellClick) {
            const gridEl = document.getElementById('battleGrid');
            if (!gridEl) return;
            gridEl.innerHTML = '';
            const targetData = state.playersData[targetId];
            if (!targetData) return;
            const flatGrid = targetData.grid || [];
            if (flatGrid.length === 0) return;

            const misses = targetData.misses || [];
            const islandHits = targetData.islandHits || [];
            const isSelf = targetId === state.currentUser.uid;

            for (let r = 0; r < CONSTANTS.ROWS; r++) {
                for (let c = 0; c < CONSTANTS.COLS; c++) {
                    const idx = r * CONSTANTS.COLS + c;
                    const cell = document.createElement('div');
                    let baseClass = 'w-10 h-10 grid-cell rounded-sm cell-water';
                    let overlayClass = '';

                    if (isSelf) {
                        if (flatGrid[idx] === 1) baseClass = 'cell-island';
                        const ship = targetData.ships.find(s => {
                            if (s.vertical) return c === s.c && r >= s.r && r < s.r + s.size;
                            else return r === s.r && c >= s.c && c < s.c + s.size;
                        });
                        if (ship) baseClass = 'cell-ship';
                        if (targetData.turrets.some(t => t.r === r && t.c === c)) baseClass = 'cell-turret';
                    }

                    if (misses.some(m => m.r === r && m.c === c)) overlayClass = 'cell-miss';
                    if (islandHits.some(h => h.r === r && h.c === c)) overlayClass = 'cell-island-hit';
                    targetData.ships.forEach(s => {
                        for (let i = 0; i < s.size; i++) {
                            let sr = s.r + (s.vertical ? i : 0);
                            let sc = s.c + (s.vertical ? 0 : i);
                            if (sr === r && sc === c && s.hits[i]) overlayClass = 'cell-hit';
                        }
                    });

                    if (!isSelf && state.pendingAttacks.some(a => a.targetId === targetId && a.r === r && a.c === c)) {
                        cell.classList.add('ring-2', 'ring-red-500', 'z-20', 'bg-red-500/40');
                        cell.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-red-500 opacity-50"><i class="fa-solid fa-crosshairs text-[10px]"></i></div>';
                    }

                    cell.className = `${baseClass} ${overlayClass}`;
                    if (!isSelf && !overlayClass && onCellClick) {
                        cell.onclick = () => onCellClick(targetId, r, c);
                    }
                    gridEl.appendChild(cell);
                }
            }
        }

        function showEliminatedOverlay() {
            if (document.getElementById('eliminatedOverlay')) return;
            const overlay = document.createElement('div');
            overlay.id = 'eliminatedOverlay';
            overlay.className = 'fixed inset-0 z-40 bg-red-900/40 backdrop-blur-sm flex flex-col items-center justify-center pointer-events-none';
            overlay.innerHTML = `
                <div class="bg-black/80 p-8 rounded-xl border-2 border-red-600 shadow-[0_0_50px_rgba(220,38,38,0.5)] text-center transform scale-110">
                    <h1 class="text-6xl font-black text-red-500 tracking-widest mb-2" style="text-shadow: 0 0 20px red;">ELIMINATED</h1>
                    <p class="text-xl text-red-200 font-mono tracking-widest">SPECTATOR MODE ACTIVE</p>
                </div>
            `;
            document.body.appendChild(overlay);
            const fireBtn = document.getElementById('fireBtn');
            if (fireBtn) {
                fireBtn.disabled = true;
                fireBtn.classList.add('opacity-50', 'cursor-not-allowed');
                fireBtn.innerHTML = '<i class="fa-solid fa-eye"></i> SPECTATING';
            }
        }

        function showVictoryOverlay() {
            if (document.getElementById('victoryOverlay')) return;
            const overlay = document.createElement('div');
            overlay.id = 'victoryOverlay';
            overlay.className = 'fixed inset-0 z-50 bg-blue-900/80 backdrop-blur-md flex flex-col items-center justify-center';
            overlay.innerHTML = `
                <div class="text-center animate-bounce mb-8">
                    <i class="fa-solid fa-trophy text-8xl text-yellow-400 drop-shadow-[0_0_30px_rgba(250,204,21,0.8)]"></i>
                </div>
                <h1 class="text-7xl font-black text-white tracking-widest mb-4 drop-shadow-lg">VICTORY</h1>
                <p class="text-2xl text-blue-200 font-mono mb-8">MISSION ACCOMPLISHED</p>
                <button onclick="location.reload()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-4 px-12 rounded-full shadow-lg transition-all transform hover:scale-105">
                    RETURN TO BASE
                </button>
            `;
            document.body.appendChild(overlay);
        }

        function showGameOverOverlay(winnerName) {
            if (document.getElementById('gameOverOverlay')) return;
            const overlay = document.createElement('div');
            overlay.id = 'gameOverOverlay';
            overlay.className = 'fixed inset-0 z-50 bg-black/90 backdrop-blur-md flex flex-col items-center justify-center';
            overlay.innerHTML = `
                <h1 class="text-6xl font-black text-slate-500 tracking-widest mb-4">GAME OVER</h1>
                <div class="text-center mb-8">
                    <p class="text-slate-400 text-sm uppercase tracking-widest mb-2">WINNER</p>
                    <p class="text-4xl font-bold text-white">${winnerName}</p>
                </div>
                <button onclick="location.reload()" class="border border-slate-600 hover:bg-slate-800 text-slate-300 font-bold py-3 px-8 rounded transition-all">
                    RETURN TO BASE
                </button>
            `;
            document.body.appendChild(overlay);
        }

        // --- Game Logic ---
        async function initAuth() {
            if (!auth) return;
            try { await signInAnonymously(auth); }
            catch (error) { console.error("Auth Error:", error); alert("Login Failed"); }
        }

        function setupAuthListener() {
            if (auth) {
                onAuthStateChanged(auth, (user) => { if (user) state.currentUser = user; });
                initAuth();
            }
        }

        window.verifyHost = () => {
            const pass = document.getElementById('hostPasswordInput').value;
            if (pass === 'admin1234') { closePasswordModal(); joinGame('host'); }
            else { alert("ACCESS DENIED"); }
        };

        window.joinGame = async (role = 'client') => {
            if (!auth) return alert("Firebase not configured.");
            if (!state.currentUser) return alert("Connecting...");
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) return alert("Identify yourself!");

            state.currentGameId = CONSTANTS.FIXED_ROOM_ID;
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId);

            try {
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) {
                    await setDoc(gameRef, { status: 'lobby', createdAt: Date.now(), round: 1, hostId: state.currentUser.uid });
                    state.playerRole = 'host';
                } else {
                    if (role === 'host') { await updateDoc(gameRef, { hostId: state.currentUser.uid }); state.playerRole = 'host'; }
                    else { state.playerRole = 'client'; }
                }

                if (state.playerRole === 'host') {
                    document.getElementById('hostControls').classList.remove('hidden-el');
                    document.getElementById('clientWaiting').classList.add('hidden-el');
                } else {
                    document.getElementById('hostControls').classList.add('hidden-el');
                    document.getElementById('clientWaiting').classList.remove('hidden-el');
                }

                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'players', state.currentUser.uid), {
                    name: username, id: state.currentUser.uid, status: 'joining', ammo: 3, bonusAmmo: 0, joinedAt: Date.now()
                });

                startLobbyListener();
                showScreen('lobbyScreen');
            } catch (e) { console.error("Join Error:", e); alert("Error joining game: " + e.message); }
        };


        function startLobbyListener() {
            onSnapshot(collection(db, "artifacts", appId, "public", "data", "games", state.currentGameId, "players"), (snapshot) => {
                const list = document.getElementById("lobbyPlayerList");
                if (!list) return;
                list.innerHTML = "";
                state.playersData = {};
                let count = 0;
                let amIInGame = false;

                snapshot.forEach(doc => {
                    const p = doc.data();
                    if (p.id === state.currentUser.uid) amIInGame = true;
                    state.playersData[p.id] = p;
                    count++;

                    const div = document.createElement("div");
                    div.className = "bg-slate-800/50 p-3 rounded border border-slate-700 flex items-center gap-3 hover:bg-slate-800 transition group relative";
                    div.innerHTML = `
                        <div class="w-10 h-10 rounded bg-slate-700 flex items-center justify-center font-bold text-sm text-slate-300 border border-slate-600">${p.name.substring(0, 2).toUpperCase()}</div>
                        <div class="flex-1 min-w-0">
                            <div class="truncate font-bold text-slate-200 text-sm">${p.name}</div>
                            <div class="text-[10px] text-slate-500 font-mono uppercase">${p.id === state.currentUser.uid ? "YOU" : "ALLY"}</div>
                        </div>
                        ${p.status === "ready" || p.status === "alive" ? "<div class=\"px-2 py-1 bg-green-900/30 border border-green-800 rounded text-[10px] text-green-400 font-bold uppercase tracking-wider\">Ready</div>" : "<div class=\"w-2 h-2 bg-slate-600 rounded-full\"></div>"}
                    `;

                    if (state.playerRole === "host" && p.id !== state.currentUser.uid) {
                        const kickBtn = document.createElement("button");
                        kickBtn.className = "ml-2 text-slate-600 hover:text-red-500 transition opacity-0 group-hover:opacity-100";
                        kickBtn.innerHTML = "<i class=\"fa-solid fa-user-xmark\"></i>";
                        kickBtn.title = "Kick Player";
                        kickBtn.onclick = (e) => { e.stopPropagation(); kickPlayer(p.id, p.name); };
                        div.appendChild(kickBtn);
                    }

                    list.appendChild(div);
                });

                if (!amIInGame && state.currentUser && state.playerRole !== "host") {
                    alert("You have been discharged from the operation.");
                    location.reload();
                    return;
                }

                document.getElementById("playerCount").innerText = count;
                checkGameStatus();
            });
        }

        function checkGameStatus() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId), (docSnap) => {
                if (!docSnap.exists()) return;
                state.gameData = docSnap.data();
                if (state.gameData.status === 'setup') {
                    showScreen('setupScreen');
                    renderSetupGrid();
                } else if (state.gameData.status === 'battle') {
                    startBattle();
                }
            });
        }

        window.startGameSetup = async () => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId), { status: 'setup' });
        };

        // --- Setup Logic ---
        window.selectTool = (tool) => {
            state.currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('ring-2', 'ring-white'));
            const btn = document.getElementById('btn-' + tool);
            if (btn) btn.classList.add('ring-2', 'ring-white');
            renderSetupGrid();
        };

        window.toggleOrientation = () => {
            state.isVertical = !state.isVertical;
            const btn = document.getElementById('btn-rotate');
            btn.innerHTML = state.isVertical ? '<i class="fa-solid fa-arrow-down"></i> VERTICAL' : '<i class="fa-solid fa-arrow-right"></i> HORIZONTAL';
        };

        window.clearBoard = () => {
            for (let r = 0; r < CONSTANTS.ROWS; r++) state.setupGridData[r].fill(0);
            state.setupObjects.turrets = [];
            state.setupObjects.ships = [];
            state.currentShipIdx = 0;
            renderSetupGrid();
        };

        window.randomizeBoard = () => {
            window.clearBoard();
            alert("Randomizer temporarily disabled. Please place manually.");
        };


        function getShipName(size) {
            if (size === 4) return "BATTLESHIP";
            if (size === 3) return "CRUISER";
            if (size === 2) return "DESTROYER";
            if (size === 1) return "SUBMARINE";
            return "SHIP";
        }

        function handleSetupHover(r, c, isEnter) {
            const gridEl = document.getElementById("setupGrid");
            if (!gridEl) return;

            // Clear previous previews
            if (isEnter) {
                document.querySelectorAll(".preview-cell").forEach(el => {
                    el.classList.remove("preview-cell", "bg-green-500/50", "bg-red-500/50");
                });
            }

            if (!isEnter) return;

            const cells = gridEl.children;
            const idx = r * CONSTANTS.COLS + c;

            if (state.currentTool === "island") {
                if (idx < cells.length) {
                    const cell = cells[idx];
                    const isValid = state.setupGridData[r][c] === 0; // Simplified valid check for visual
                    cell.classList.add("preview-cell", isValid ? "bg-green-500/50" : "bg-red-500/50");
                }
            } else if (state.currentTool === "ship") {
                const size = CONSTANTS.SHIPS_CONFIG[state.currentShipIdx];
                if (size === undefined) return;

                let isValid = true;
                const shipCells = [];

                for (let i = 0; i < size; i++) {
                    let sr = r + (state.isVertical ? i : 0);
                    let sc = c + (state.isVertical ? 0 : i);

                    if (sr >= CONSTANTS.ROWS || sc >= CONSTANTS.COLS) {
                        isValid = false;
                        continue;
                    }

                    const sIdx = sr * CONSTANTS.COLS + sc;
                    if (sIdx < cells.length) shipCells.push(cells[sIdx]);

                    // Check collision
                    if (state.setupGridData[sr][sc] === 1 ||
                        state.setupObjects.ships.some(s => {
                            // Simple collision check logic here or reuse existing
                            return false; // Visual only for now, logic handled in click
                        })) {
                        // Detailed collision check is complex to replicate in hover without helper, 
                        // but we can check basic grid data if we had it mapped. 
                        // For now, just bounds check is good visual feedback.
                    }
                }

                shipCells.forEach(cell => {
                    cell.classList.add("preview-cell", isValid ? "bg-green-500/50" : "bg-red-500/50");
                });
            }
        }

        
        window.undoLastAction = () => {
            if (state.currentTool === "ship") {
                if (state.currentShipIdx > 0) {
                    state.currentShipIdx--;
                    // Remove the ship that corresponds to this index (which is the last one added)
                    // Since we add sequentially, popping is safe enough, but filtering is safer if order got mixed
                    // But based on handleSetupClick, we push. So pop is fine.
                    state.setupObjects.ships.pop();
                    renderSetupGrid();
                }
            } else if (state.currentTool === "turret") {
                if (state.setupObjects.turrets.length > 0) {
                    state.setupObjects.turrets.pop();
                    renderSetupGrid();
                }
            }
        };

        function renderSetupGrid() {
            const gridEl = document.getElementById("setupGrid");
            if (!gridEl) return;
            gridEl.innerHTML = "";

            // Update Island Count
            const currentIslands = state.setupGridData.flat().filter(x => x === 1).length;
            const countDisplay = document.getElementById("islandCountDisplay");
            if (countDisplay) countDisplay.innerText = `${currentIslands}/${CONSTANTS.ISLAND_LIMIT}`;

            renderFleetSidebar();

            for (let r = 0; r < CONSTANTS.ROWS; r++) {
                for (let c = 0; c < CONSTANTS.COLS; c++) {
                    const cell = document.createElement("div");
                    let className = "grid-cell";
                    if (state.setupGridData[r][c] === 1) className += " cell-island";

                    const ship = state.setupObjects.ships.find(s => {
                        if (s.vertical) return c === s.c && r >= s.r && r < s.r + s.size;
                        else return r === s.r && c >= s.c && c < s.c + s.size;
                    });
                    if (ship) className += " cell-ship";

                    if (state.setupObjects.turrets.some(t => t.r === r && t.c === c)) className += " cell-turret";

                    cell.className = className;
                    cell.onclick = () => handleSetupClick(r, c);
                    cell.onmouseenter = () => handleSetupHover(r, c, true);
                    cell.onmouseleave = () => handleSetupHover(r, c, false);

                    gridEl.appendChild(cell);
                }
            }
        }


        function handleSetupClick(r, c) {
            if (state.currentTool === "island") {
                let currentIslands = state.setupGridData.flat().filter(x => x === 1).length;
                if (state.setupGridData[r][c] === 0) {
                    if (currentIslands < CONSTANTS.ISLAND_LIMIT) state.setupGridData[r][c] = 1;
                } else { state.setupGridData[r][c] = 0; }
            } else if (state.currentTool === "turret") {
                const exists = state.setupObjects.turrets.find(t => t.r === r && t.c === c);
                if (exists) state.setupObjects.turrets = state.setupObjects.turrets.filter(t => t !== exists);
                else state.setupObjects.turrets.push({ r, c });
            } else if (state.currentTool === "ship") {
                const size = CONSTANTS.SHIPS_CONFIG[state.currentShipIdx];
                if (size === undefined) return;

                let valid = true;
                for (let i = 0; i < size; i++) {
                    let sr = r + (state.isVertical ? i : 0);
                    let sc = c + (state.isVertical ? 0 : i);
                    if (sr >= CONSTANTS.ROWS || sc >= CONSTANTS.COLS) { valid = false; break; }
                    if (state.setupGridData[sr][sc] === 1) { valid = false; break; }

                    const collision = state.setupObjects.ships.some((s, sIdx) => {
                        if (sIdx === state.currentShipIdx) return false;
                        for (let j = 0; j < s.size; j++) {
                            let osr = s.r + (s.vertical ? j : 0);
                            let osc = s.c + (s.vertical ? 0 : j);
                            if (sr === osr && sc === osc) return true;
                        }
                        return false;
                    });
                    if (collision) { valid = false; break; }
                }

                if (valid) {
                    state.setupObjects.ships = state.setupObjects.ships.filter((_, idx) => idx !== state.currentShipIdx);

                    state.setupObjects.ships.push({
                        r, c, size, vertical: state.isVertical, hits: Array(size).fill(false)
                    });

                    if (state.currentShipIdx < CONSTANTS.SHIPS_CONFIG.length - 1) {
                        state.currentShipIdx++;
                    }
                }
            }
            renderSetupGrid();
        }

        window.submitBoard = async () => {
            try {
                if (state.setupObjects.ships.length < CONSTANTS.SHIPS_CONFIG.length) {
                    alert(`Deploy all ships! (${state.setupObjects.ships.length}/${CONSTANTS.SHIPS_CONFIG.length})`);
                    return;
                }
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'players', state.currentUser.uid), {
                    grid: state.setupGridData.flat(), turrets: state.setupObjects.turrets, ships: state.setupObjects.ships, status: 'ready'
                });
                document.getElementById('setupWaitingRoom').classList.remove('hidden-el');
                if (state.playerRole === 'host') {
                    document.getElementById('setupHostControls').classList.remove('hidden-el');
                    document.getElementById('setupClientMessage').classList.add('hidden-el');
                } else {
                    document.getElementById('setupHostControls').classList.add('hidden-el');
                    document.getElementById('setupClientMessage').classList.remove('hidden-el');
                }
                monitorSetupReadiness();
            } catch (error) { console.error("Submit Error:", error); alert("Error submitting board: " + error.message); }
        };

        function monitorSetupReadiness() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'players'), (snapshot) => {
                const list = document.getElementById('setupPlayerList');
                if (!list) return;
                list.innerHTML = '';
                let allReady = true;
                let playerCount = 0;
                snapshot.forEach(doc => {
                    const p = doc.data();
                    if (p.status === 'joining') return;
                    playerCount++;
                    const isReady = p.status === 'ready' || p.status === 'alive';
                    if (!isReady) allReady = false;
                    const div = document.createElement('div');
                    div.className = `p-3 rounded border flex items-center justify-between ${isReady ? 'bg-green-900/20 border-green-500/30' : 'bg-slate-800 border-slate-700'}`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded flex items-center justify-center font-bold text-xs ${isReady ? 'bg-green-500 text-white' : 'bg-slate-700 text-slate-400'}">
                                ${isReady ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-wrench"></i>'}
                            </div>
                            <span class="font-bold text-slate-200 text-sm">${p.name}</span>
                        </div>
                        <span class="text-[10px] font-mono uppercase tracking-wider ${isReady ? 'text-green-400' : 'text-yellow-500'}">
                            ${isReady ? 'READY FOR BATTLE' : 'CONFIGURING TERRITORY'}
                        </span>
                    `;
                    list.appendChild(div);
                });
                const startBtn = document.getElementById('forceStartBtn');
                if (state.playerRole === 'host' && startBtn) {
                    if (allReady && playerCount > 0) {
                        startBtn.disabled = false;
                        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        startBtn.classList.add('animate-pulse');
                    } else {
                        startBtn.disabled = true;
                        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        startBtn.classList.remove('animate-pulse');
                    }
                }
            });
        }

        window.initiateBattleSequence = async () => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId), { status: 'battle' });
        };

        // --- Battle Logic ---
        function startBattle() {
            document.getElementById('setupScreen').classList.add('hidden-el');
            showScreen('battleScreen');
            updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'players', state.currentUser.uid), { status: 'alive' });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'players'), (snap) => {
                const list = document.getElementById('enemyList');
                list.innerHTML = '';
                state.playersData = {};
                snap.forEach(d => {
                    const p = d.data();
                    state.playersData[p.id] = p;
                    if (p.id === state.currentUser.uid) {
                        state.currentRoundAmmo = p.ammo;
                        document.getElementById('myAmmo').innerText = p.ammo;
                        document.getElementById('bonusAmmo').innerText = p.bonusAmmo;
                        updateFireButton();
                        if (!state.selectedEnemyId) renderBattleGrid(state.currentUser.uid); if (state.playerRole === "host") document.getElementById("hostResetBtn").classList.remove("hidden-el"); if (state.playerRole === "host") document.getElementById("hostResetBtn").classList.remove("hidden-el");
                    } else if (p.status === 'alive') {
                        const btn = document.createElement('button');
                        btn.className = `w-full text-left p-3 rounded mb-2 transition flex justify-between items-center shadow-sm border ${state.selectedEnemyId === p.id ? 'bg-red-900/40 border-red-500 text-white shadow-[0_0_10px_rgba(239,68,68,0.3)]' : 'bg-slate-800 border-slate-700 text-slate-300 hover:bg-slate-700 hover:border-slate-600'}`;
                        btn.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${state.selectedEnemyId === p.id ? 'bg-red-500 animate-pulse' : 'bg-slate-500'}"></span>
                            <span class="font-bold text-sm">${p.name}</span>
                        </div>
                        <i class="fa-solid fa-crosshairs ${state.selectedEnemyId === p.id ? 'text-red-400' : 'text-slate-500'}"></i>`;
                        btn.onclick = () => selectEnemy(p.id, p.name);
                        list.appendChild(btn);
                    } else if (p.status === 'eliminated') {
                        const div = document.createElement('div');
                        div.className = "w-full text-left p-2 rounded mb-1 bg-slate-900/50 border border-slate-800 text-slate-600 text-xs italic flex justify-between";
                        div.innerHTML = `<span> ${p.name}</span> <span>KIA</span>`;
                        list.appendChild(div);
                    }
                });
                if (state.selectedEnemyId) renderBattleGrid(state.selectedEnemyId, toggleTarget);
                else renderBattleGrid(state.currentUser.uid);
                checkWinCondition();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId), (docSnap) => {
                const data = docSnap.data();
                if (data.round !== parseInt(document.getElementById('roundDisplay').innerText)) {
                    document.getElementById('roundDisplay').innerText = data.round;
                    state.pendingAttacks = [];
                    updateFireButton();
                    const fireBtn = document.getElementById('fireBtn');
                    fireBtn.innerHTML = `<i class="fa-solid fa-crosshairs"></i> FIRE (0/${state.currentRoundAmmo})`;
                    fireBtn.disabled = false;
                    document.getElementById('phaseStatus').innerHTML = '<span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span> SELECT TARGETS';
                }
            });
        }

        function selectEnemy(id, name) {
            state.selectedEnemyId = id;
            const badge = document.getElementById('targetName');
            badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> LOCK: ${name}`;
            badge.className = "mx-auto mt-4 px-6 py-2 bg-red-900/80 rounded-full border border-red-500 text-sm font-mono text-white shadow-[0_0_20px_rgba(220,38,38,0.5)] z-10 flex items-center gap-3";
            renderBattleGrid(id, toggleTarget);
            updateFireButton();
        }

        function toggleTarget(targetId, r, c) {
            const exists = state.pendingAttacks.find(a => a.targetId === targetId && a.r === r && a.c === c);
            if (exists) state.pendingAttacks = state.pendingAttacks.filter(a => a !== exists);
            else if (state.pendingAttacks.length < state.currentRoundAmmo) state.pendingAttacks.push({ targetId, r, c });
            renderBattleGrid(targetId, toggleTarget);
            updateFireButton();
        }

        window.viewSelf = () => {
            state.selectedEnemyId = null;
            const badge = document.getElementById('targetName');
            badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-blue-500"></span> TERRITORY STATUS`;
            badge.className = "mx-auto mt-4 px-6 py-2 bg-blue-900/80 rounded-full border border-blue-500 text-sm font-mono text-white shadow-[0_0_20px_rgba(37,99,235,0.5)] z-10 flex items-center gap-3";
            renderBattleGrid(state.currentUser.uid);
        };

        window.confirmAttack = async () => {
            if (state.pendingAttacks.length === 0) return;
            const btn = document.getElementById('fireBtn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> TRANSMITTING...`;
            document.getElementById('phaseStatus').innerHTML = '<span class="text-yellow-400">WAITING FOR RESOLUTION</span>';
            const batch = writeBatch(db);
            const moveRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'moves', `${state.gameData.round}_${state.currentUser.uid}`);
            batch.set(moveRef, { playerId: state.currentUser.uid, attacks: state.pendingAttacks, round: state.gameData.round, timestamp: Date.now() });
            batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'players', state.currentUser.uid), { moveSubmitted: true });
            await batch.commit();
            if (state.playerRole === 'host') monitorMovesAndResolve();
        };

        function monitorMovesAndResolve() {
            const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'moves'), async (snap) => {
                const currentRoundMoves = snap.docs.filter(d => d.data().round === state.gameData.round);
                const alivePlayers = Object.values(state.playersData).filter(p => p.status === 'alive');
                if (currentRoundMoves.length >= alivePlayers.length && alivePlayers.length > 0) {
                    unsub();
                    resolveRound(currentRoundMoves.map(d => d.data()));
                }
            });
        }

        async function resolveRound(allMoves) {
            const batch = writeBatch(db);
            let updates = {};
            allMoves.forEach(move => {
                move.attacks.forEach(att => {
                    const target = state.playersData[att.targetId];
                    if (!target || target.status !== 'alive') return;
                    if (!updates[att.targetId]) updates[att.targetId] = { misses: target.misses || [], islandHits: target.islandHits || [], ships: target.ships, bonusAmmo: 0 };
                    const tData = updates[att.targetId];
                    const r = att.r, c = att.c;
                    const flatIdx = r * CONSTANTS.COLS + c;
                    let hitShip = false;
                    tData.ships.forEach(ship => {
                        for (let i = 0; i < ship.size; i++) {
                            let sr = ship.r + (ship.vertical ? i : 0);
                            let sc = ship.c + (ship.vertical ? 0 : i);
                            if (sr === r && sc === c) { ship.hits[i] = true; hitShip = true; }
                        }
                    });
                    if (!hitShip) {
                        if (target.grid[flatIdx] === 1) { tData.islandHits.push({ r, c }); tData.bonusAmmo++; }
                        else tData.misses.push({ r, c });
                    }
                });
            });

            Object.keys(updates).forEach(pid => {
                const u = updates[pid];
                let allSunk = true;
                u.ships.forEach(s => { if (s.hits.includes(false)) allSunk = false; });
                const newStatus = allSunk ? 'eliminated' : 'alive';
                batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'players', pid), {
                    ships: u.ships, misses: u.misses, islandHits: u.islandHits, bonusAmmo: u.bonusAmmo,
                    ammo: 3 + u.bonusAmmo, status: newStatus, moveSubmitted: false
                });
            });

            Object.keys(state.playersData).forEach(pid => {
                if (!updates[pid] && state.playersData[pid].status === 'alive') {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId, 'players', pid), { ammo: 3, bonusAmmo: 0, moveSubmitted: false });
                }
            });

            batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'games', state.currentGameId), { round: increment(1) });
            await batch.commit();
        }

        function checkWinCondition() {
            const alivePlayers = Object.values(state.playersData).filter(p => p.status === 'alive');
            const myPlayer = state.playersData[state.currentUser.uid];
            if (myPlayer && myPlayer.status === 'eliminated') { showEliminatedOverlay(); }
            if (state.gameData.status === 'battle' && alivePlayers.length === 1) {
                const winner = alivePlayers[0];
                if (winner.id === state.currentUser.uid) {
                    showVictoryOverlay();
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                } else { showGameOverOverlay(winner.name); }
            }
        }

        setupAuthListener();
    </script>
</body>

</html>